#include "../solver_configurations.h"
#include <stdio.h>

double rk810_error_correlation(double h, double F[MAX_BUTCHER_TABLEAU_SIZE][VEC_SIZE])
{
    // F: array of slopes at each stage

    // error = 1/360 * h * (F[1] - F[15])
    double err_vector[3] = {0.0, 0.0, 0.0};
    for (size_t component = 0; component < 3; component++)
    // only take position component of error
    {
        err_vector[component] = 1. / 360. * h * (F[1][component] - F[15][component]);
        printf("err_vector[%d] = %f\n", component, err_vector[component]);
    }

    return sqrt(err_vector[0] * err_vector[0] + err_vector[1] * err_vector[1] + err_vector[2] * err_vector[2]);
}

RKSolver rk810()
{
    // copied directly from old Supernova code
    // https://github.com/spacesys-finch/supernova/blob/main/c_code/solvers.h
    static const double RK810a[17][17] = {
        {
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.1,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            -0.9151765613752915,
            1.4545344021782731,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.20225919030111816,
            0.0,
            0.6067775709033545,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.18402471470864357,
            0.0,
            0.19796683122719236,
            -0.07295478473136326,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.08790073402066813,
            0.0,
            0.0,
            0.41045970252026065,
            0.4827137536788665,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.08597005049024603,
            0.0,
            0.0,
            0.3308859630407222,
            0.4896629573094502,
            -0.07318563750708508,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.12093044912533372,
            0.0,
            0.0,
            0.0,
            0.2601246757582956,
            0.032540262154909134,
            -0.0595780211817361,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.11085437958039149,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.06057614882550056,
            0.3217637056017784,
            0.510485725608063,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.112054414752879,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.14494277590286592,
            -0.3332697190962567,
            0.4992692295568801,
            0.5095046089296861,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.11397678396418598,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.07688133642033569,
            0.23952736032439065,
            0.3977746623680946,
            0.010755895687360746,
            -0.3277691241640189,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.07983145282801961,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.052032968680060306,
            -0.05769541461685489,
            0.19478191571210415,
            0.14538492318832508,
            -0.07829427103516708,
            -0.11450329936109892,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.9851156101648573,
            0.0,
            0.0,
            0.3308859630407222,
            0.4896629573094502,
            -1.3789648657484357,
            -0.8611641950276356,
            5.784288136375372,
            3.2880776198510357,
            -2.386339050931364,
            -3.254793424836439,
            -2.16343541686423,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            0.8950802957716328,
            0.0,
            0.19796683122719236,
            -0.07295478473136326,
            0.0,
            -0.8512362396620076,
            0.3983201123185333,
            3.639372631810356,
            1.5482287703983033,
            -2.122217147040537,
            -1.5835039854532618,
            -1.7156160828593627,
            -0.024403640575012746,
            0.0,
            0.0,
            0.0,
            0.0,
        },
        {
            -0.9151765613752915,
            1.4545344021782731,
            0.0,
            0.0,
            -0.7773336436449683,
            0.0,
            -0.0910895662155176,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0910895662155176,
            0.7773336436449683,
            0.0,
            0.0,
            0.0,
        },
        {
            0.1,
            0.0,
            -0.15717866579977116,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.15717866579977116,
            0.0,
            0.0,
        },
        {
            0.1817813007000953,
            0.675,
            0.3427581598471898,
            0.0,
            0.25911121454832275,
            -0.35827896671795206,
            -1.0459489594088331,
            0.930327845415627,
            1.7795095943170811,
            0.1,
            -0.2825475695390441,
            -0.15932735011997254,
            -0.14551589464700151,
            -0.25911121454832275,
            0.0,
            0.0,
            0.0,
        },
    };

    static const double RK810c[17] = {
        0.0,
        0.1,
        0.5393578408029818,
        0.8090367612044727,
        0.30903676120447265,
        0.9810741902197953,
        0.8333333333333334,
        0.3540173658568024,
        0.8825276619647323,
        0.6426157582403226,
        0.3573842417596775,
        0.11747233803526766,
        0.8333333333333334,
        0.30903676120447265,
        0.5393578408029818,
        0.1,
        1.0,
    };
    static const double RK810b[17] = {
        0.03333333333333333,
        0.025,
        0.03333333333333333,
        0.0,
        0.05,
        0.0,
        0.04,
        0.0,
        0.1892374781489235,
        0.2774291885177432,
        0.2774291885177432,
        0.1892374781489235,
        -0.04,
        -0.05,
        -0.03333333333333333,
        -0.025,
        0.03333333333333333,
    };
    static const ButcherTableau weights = {
        .A = RK810a,
        .b = RK810b,
        .c = RK810c};

    static RKSolver solver = {
        .weights = &weights,
        .err_corr = rk810_error_correlation,
        .is_adaptive = true,
        .num_stages = 17,
        .order = 10};
    return solver;
}